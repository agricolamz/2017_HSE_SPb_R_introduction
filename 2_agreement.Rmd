---
title: "2. Меры согласия"
author: "Г. Мороз <br> Презентация доступна по ссылке: goo.gl/mdkzaT"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

<style>
.parallax {
    /* The image used */
    background-image: url("2_argue.jpg");
    
    /* Set a specific height */
    min-height: 300px; 

    /* Create the parallax scrolling effect */
    background-attachment: fixed;
    background-position: center;
    background-repeat: no-repeat;
    background-size: auto;
}
</style>

<div class="parallax"></div>


### 1. Введение

* ваши данные представляют собой много наблюдений одного и того же полученные разным способом
    * несколько докторов ставит диагноз нескольким пациентам
    * несколько информантов оценили род в некотором списке слов
    * несколько информантов оценили приемлимость высказываний на школе от 1 до 5
    * разметчики независимо разметили какие-то явления на одном и том же материале
    
* __Насколько суждения разных оценщиков (*raters*) относительно субъектов оценки (*subjects*) согласуются между собой?__

    
#### 1.1 Данные: зиловский эксперимент
В зиловском диалекте андийского языка существует два класса для неодушевленных предметов. В 2017 году был проведен эксперимент, чтобы проверить, наличие вариативности в отнесению к тому или иному классу заимствованой и исконной лексики.

```{r}
zilo_classes <- read.csv("https://goo.gl/MPquvV")
head(zilo_classes)
```

Переменные в датасете:

* stimulus
* translation_ru
* stimulus_source — тип слова: исконное или заимствованное
* s_1, s_2 ... — ответы испытуемых

#### 1.2 Данные: переводы 57 сонета У. Шекспира
В данном датасете я собрал информацию о количестве слогов в переводах 57 сонета У. Шекспира и в самом сонете.

```{r}
sonet <- read.csv("https://goo.gl/cqPDkq")
head(sonet)
```

* line — номер строки
* остальные переменные — количество слогов в переводах

#### 1.3 Данные: исследование маргинальных русских глаголов
Данные взяты из [исследования [Endresen, Janda 2015]](https://goo.gl/GC4RjQ), посвященное исследованию маргинальных глаголов изменения состояния в русском языке. Испытуемые (70 школьников, 51 взрослый) оценивали по [шкале Ликерта (1...5)](https://goo.gl/R4gHiq) приемлемость глаголов с приставками _о-_ и _у-_:

* широко используемуе в СРЛЯ (_освежить_, _уточнить_)
* встретившие всего несколько раз в корпусе (_оржавить_, _увкуснить_)
* искусственные слова (_ономить_, _укампить_)

```{r}
marginal_verbs <- read.csv("https://goo.gl/Pq1S8V")
head(marginal_verbs)
```

Переменные в датасете:

* Stimulus
* WordType — тип слова: частотное, редкое, искусственное
* Prefix
* Остальные переменные  — ответы испытуемых

<div class="parallax"></div>


### 2. Процент полного согласия
Процент полного согласия — это процент случаев, когда все оценщики идентичны в своих суждениях.

```{r}
#install.packages("irr") установите пакет!
library("irr")
agree(zilo_classes[,-c(1:3)])
round(74.5*106/100) # количество случаев полного согласия
agree(sonet[,-1])
```

Эту меру иногда ошибочно приводят как меру согласия оценщиков, однако она не учитывает возможность случайного совпадения / расхождения суждений.

> ![](think.png) (1) Посчитайте процент полного согласия в данных о маргинальных глаголах. <br>
> ![](think2.png) (2) Посчитайте количество случаев полного согласия в данных о маргинальных глаголах.

```{r, include= FALSE}
agree(marginal_verbs[,-c(1:3)])
round(10.2*59/100) # количество случаев полного согласия
```


<div class="parallax"></div>

### 3. Каппа Коэна
Каппа Коэна мера согласованности между двумя категориальными переменными. Обычно говорят о двух оценщиках, которые распеделяют $n$ наблюдений по $s$ категориям.

$\kappa = \frac{p_o-p_e}{1-p_e},$

где $p_o$ — доля полного согласия, а $p_e$ — вероятность случайного согласия.

Для случая $s$ = 2, можно нарисовать следующую таблицу сопряженности:

|       | $s_1$ | $s_2$ |
|:-----:|:-----:|:-----:|
| $s_1$ |   a   |   b   |
| $s_2$ |   c   |   d   |

В таком случае:

* $p_o = \frac{a+d}{a+b+c+d}$
* $p_e = \frac{(a+b)\times(a+c) + (d+b)\times(d+c)}{(a+b+c+d)^2}$

Выберем двух спикиров из наших данных:
```{r}
zilo_classes_2s <- zilo_classes[,c(4, 14)]
agree(zilo_classes_2s)
table(zilo_classes_2s)
p_o <- (47+46)/(47+46+4+9)
p_o
p_e <- ((47+9)*(47+4)+(46+9)*(46+4))/(47+9+4+46)^2
p_e
coehns_kappa <- (p_o - p_e)/(1 - p_e)
coehns_kappa
kappa2(zilo_classes_2s)
```

Функция `kappa2` из пакета `irr` также приводит p-value, которое высчитывается для нулевой гипотезы, что каппа  Коэна равна нулю.

Если вы хотите, чтобы ваши оценщики не оценивались как равноценные, вы можете использовать взвешенную каппу Коэна.

В [Landis, Koch 1977] предложена следующая интерпретация каппы Коэна:

* κ < 0 poor agreement
* 0–0.20 slight agreement
* 0.21–0.40 fair agreement
* 0.41–0.60 moderate agreement
* 0.61–0.80 substantial agreement
* 0.81–1 almost perfect agreement

Каппа Коэна — не единственная мера согласия между двумя оценщиками. Существуют работы, в которых каппу Коэна ругают.

> ![](think.png) (3) Посчитайте каппу Коэна для спикеров в 4 и 120 столбцах данных про глаголы.<br>
> ![](think2.png) (4) Посчитайте каппу Коэна для переводов А. Велигжанина и М. Чайковского.

```{r, include= FALSE}
kappa2(marginal_verbs[,c(4, 120)])
kappa2(sonet[,c(2, 9)])
```

<div class="parallax"></div>

### 4. Ранговые корреляции: тау Кендалл

$$\tau = \frac{C-D}{C+D}$$

```{r, echo = FALSE}
data.frame(ranker_1 = 1:12,
           ranker_2 = c(2, 1, 4, 3, 6, 5, 8, 7, 10, 9, 12, 11),
           C = c(10, 10, 8, 8, 6, 6, 4, 4, 2, 2, 0, 0),
           D = c(1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0))
```


```{r}
data.frame(cor(sonet[, -1], method = "kendall"))
```

Бывает еще ранговая корреляция Спирмана (`cor(..., method = "spearman")`).

> ![](think.png) (5) Какой коэфициент корреляции Кендала между спикерами в 4 и 120 столбцах данных про глаголы.

```{r, include= FALSE}
cor(marginal_verbs[,c(4, 120)], method = "kendall")
```

<div class="parallax"></div>

### 5. Каппа Фляйса
Обощением каппы Коэна для оценщиков больше двух является каппа Фляйса. $k$ оценщиков распеделяют $n$ наблюдений по $s$ категориям.

$\kappa = \frac{\bar{P}_o-\bar{P}_e}{1-\bar{P}_e},$

где $\bar{P}_o$ — средняя доля пар согласных оценщиков из всех пар, а $\bar{P}_e$ — вероятность случайного согласия.

```{r}
zilo_classes[,-c(1:3)]
```

В нашем датасете $k$ = 16, $n$ = 106, $s$ = 2.

Посчитаем, насколько оценщики согласны относительно третьего слова (3 b, 13 r). Для этого посчитаем долю пар оценщиков, которые согласны, среди всех возможных пар:

```{r}
kappam.fleiss(zilo_classes[,-c(1:3)])
kappam.fleiss(marginal_verbs[,-c(1:3)])
```
> ![](think2.png) (6) Посчитайте каппу Фляйса для сонетских данных.<br>

```{r, include= FALSE}
kappam.fleiss(sonet[,-1])
```


<div class="parallax"></div>